name: Deploy to Server

on:
  push:
    branches:
      - main # main ë¸Œëžœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show repo info
        run: echo "Repo is $GITHUB_REPOSITORY"

      - name: Set up SSH and Deploy
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          echo "ðŸ” DEPLOY_KEY length: ${#DEPLOY_KEY}"
          echo "ðŸŒ DEPLOY_HOST length: ${#DEPLOY_HOST}"
          echo "ðŸ“ DEPLOY_DIR length: ${#DEPLOY_DIR}"

          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/github_deploy_key
          chmod 600 ~/.ssh/github_deploy_key

          PROJECT_NAME=$(basename $GITHUB_REPOSITORY)

          ssh -i ~/.ssh/github_deploy_key -o StrictHostKeyChecking=no $DEPLOY_HOST << EOF
              set -ex

              echo "âœ… DEPLOY_DIR: $DEPLOY_DIR"
              mkdir -p $DEPLOY_DIR
              cd $DEPLOY_DIR

              if [ ! -d "$PROJECT_NAME" ]; then
              echo "ðŸ“¦ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë¯€ë¡œ git clone ì‹¤í–‰"
              git clone https://github.com/${GITHUB_REPOSITORY}.git
              fi

              cd $PROJECT_NAME

              echo "ðŸ”„ git pull ì‹¤í–‰"
              git pull origin main

              echo "ðŸ§ª ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜"
              if [ ! -d "venv" ]; then
              python3 -m venv venv
              fi
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
          EOF
